steps:
  - id: install
    name: 'gcr.io/cloud-builders/npm'
    entrypoint: 'npm'
    args: ['install']

  - id: test
    name: 'gcr.io/cloud-builders/npm'
    waitFor: ['install']
    entrypoint: 'npm'
    args: ['run', 'test']

  - id: build
    name: 'gcr.io/cloud-builders/npm'
    waitFor: ['test']
    entrypoint: 'npm'
    args: ['run', 'build']

  - id: deploy
    waitFor: ['build']
    name: 'gcr.io/cloud-builders/gsutil'
    entrypoint: 'gsutil'
    args: ['-m', 'cp', '-r', 'dist/*', 'gs://ann-radar-develop']

  - id: setmeta
    waitFor: ['deploy']
    name: 'gcr.io/cloud-builders/gsutil'
    entrypoint: 'gsutil'
    args:
      [
        '-m',
        'setmeta',
        '-r',
        '-h',
        'Cache-Control: no-cache',
        'gs://ann-radar-develop/*'
      ]

  - id: slack_notification
    waitFor: ['setmeta']
    name: gcr.io/cloud-builders/curl
    entrypoint: 'bash'
    args:
      - -c
      - |
        curl -X POST -H "Content-type: application/json; charset=utf-8" -H "Authorization: Bearer $$SLACK_BOT_TOKEN" --data "{\"channel\":\"C02V2LH6LRM\",\"username\":\"Deployment\",\"icon_emoji\":\":robot_face:\",\"text\":\"New version deployed: https://storage.googleapis.com/ann-radar-develop/index.html\",\"unfurl_links\":false}" https://slack.com/api/chat.postMessage
    secretEnv: ['SLACK_BOT_TOKEN']

availableSecrets:
  secretManager:
    - versionName: projects/ann-radar-prototype-project/secrets/SLACK_BOT_TOKEN/versions/latest
      env: 'SLACK_BOT_TOKEN'
